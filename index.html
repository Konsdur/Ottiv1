<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Otti's Dashboard ğŸ’•</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
<style>
:root{--rose:#c9748a;--rose-light:#e8a4b4;--rose-pale:#f7e6ea;--blush:#fdf0f3;--gold:#c49a5a;--gold-light:#e8d5b0;--cream:#fdf8f4;--text-dark:#3a2a2f;--text-mid:#6b4d57;--text-light:#a8828e;--card-bg:rgba(255,255,255,0.82);--shadow:0 8px 40px rgba(170,100,120,0.13);--radius:20px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Lato',sans-serif;background:var(--blush);color:var(--text-dark);min-height:100vh;overflow-x:hidden}body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse at 10% 10%,rgba(231,168,185,0.22) 0%,transparent 55%),radial-gradient(ellipse at 90% 80%,rgba(196,154,90,0.13) 0%,transparent 50%),radial-gradient(ellipse at 60% 20%,rgba(201,116,138,0.10) 0%,transparent 40%)}.container{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:28px 20px 60px}header{text-align:center;margin-bottom:36px}.header-greeting{font-family:'Dancing Script',cursive;font-size:clamp(2.4rem,5vw,3.4rem);color:var(--rose);letter-spacing:1px;line-height:1.1}.header-sub{font-weight:300;font-size:0.95rem;color:var(--text-light);margin-top:6px;letter-spacing:2px;text-transform:uppercase}.header-divider{display:flex;align-items:center;justify-content:center;gap:14px;margin-top:14px}.header-divider span{display:block;height:1px;width:80px;background:linear-gradient(to right,transparent,var(--rose-light))}.header-divider span:last-child{background:linear-gradient(to left,transparent,var(--rose-light))}.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}.card{background:var(--card-bg);backdrop-filter:blur(14px);border:1px solid rgba(201,116,138,0.14);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;transition:transform 0.25s,box-shadow 0.25s;position:relative}.card:hover{transform:translateY(-3px);box-shadow:0 14px 50px rgba(170,100,120,0.18)}.card-title{font-family:'Playfair Display',serif;font-size:0.82rem;letter-spacing:3px;text-transform:uppercase;color:var(--text-light);margin-bottom:16px;display:flex;align-items:center;gap:7px}.card-clock{grid-column:span 4;display:flex;flex-direction:column;align-items:center;text-align:center}.clock-time{font-family:'Playfair Display',serif;font-size:clamp(3rem,5vw,4.4rem);font-weight:700;color:var(--text-dark);line-height:1;letter-spacing:-1px;margin:8px 0 4px}.clock-ampm{font-weight:300;font-size:1rem;color:var(--rose);letter-spacing:3px;text-transform:uppercase}.clock-date{font-size:0.88rem;color:var(--text-light);margin-top:8px;font-weight:300}.card-weather{grid-column:span 4}.weather-main{display:flex;align-items:center;gap:14px;margin-bottom:14px}.weather-emoji{font-size:3.2rem;line-height:1}.weather-temp{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:700;color:var(--text-dark);line-height:1}.weather-unit{font-size:1.1rem;color:var(--text-light);vertical-align:super}.weather-desc{font-size:0.88rem;color:var(--text-mid);font-weight:300;margin-top:2px}.weather-loc{font-size:0.83rem;color:var(--text-light)}.weather-details{display:flex;gap:14px;margin-top:14px;padding-top:14px;border-top:1px solid rgba(201,116,138,0.12)}.weather-detail .label{font-size:0.73rem;color:var(--text-light);text-transform:uppercase;letter-spacing:1px}.weather-detail .value{font-size:0.9rem;color:var(--text-mid);margin-top:2px}.location-btn{background:rgba(201,116,138,0.15);color:var(--rose);border:1px solid rgba(201,116,138,0.3);border-radius:10px;padding:8px 14px;font-size:0.8rem;cursor:pointer;transition:all 0.2s;margin-top:10px;width:100%;font-weight:600}.location-btn:hover{background:var(--rose);color:white}.location-btn:disabled{opacity:0.5}.weather-status{font-size:0.74rem;color:var(--text-light);margin-top:8px;font-style:italic;min-height:16px}.card-affirmation{grid-column:span 4;background:linear-gradient(135deg,rgba(201,116,138,0.18),rgba(196,154,90,0.12));border-color:rgba(201,116,138,0.22);display:flex;flex-direction:column}.affirmation-text{font-family:'Playfair Display',serif;font-style:italic;font-size:clamp(0.95rem,1.7vw,1.12rem);color:var(--text-dark);line-height:1.65;flex:1;display:flex;align-items:center;transition:opacity 0.25s;min-height:90px}.affirmation-footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:14px;border-top:1px solid rgba(201,116,138,0.2)}.affirmation-num{font-size:0.75rem;color:var(--text-light);font-weight:300}.btn-affirmation{background:rgba(201,116,138,0.15);color:var(--rose);border:1px solid rgba(201,116,138,0.3);border-radius:20px;padding:6px 16px;font-size:0.78rem;cursor:pointer;transition:all 0.2s;font-weight:700;letter-spacing:1px;text-transform:uppercase}.btn-affirmation:hover{background:var(--rose);color:white}.card-calendar{grid-column:span 12}.calendar-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}.calendar-month{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--text-dark)}.cal-btn{background:none;border:1px solid rgba(201,116,138,0.3);border-radius:8px;width:30px;height:30px;cursor:pointer;color:var(--rose);transition:all 0.18s;display:flex;align-items:center;justify-content:center}.cal-btn:hover{background:var(--rose);color:white}.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center}.cal-day-name{font-size:0.7rem;font-weight:700;color:var(--text-light);letter-spacing:1px;text-transform:uppercase;padding:4px 0 8px}.cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:0.82rem;border-radius:50%;cursor:pointer;transition:all 0.18s;color:var(--text-mid);position:relative}.cal-day:hover{background:var(--rose-pale)}.cal-day.today{background:var(--rose);color:white;font-weight:700}.cal-day.other-month{color:var(--rose-light);opacity:0.5}.cal-day.has-event::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--gold)}.cal-day.today.has-event::after{background:white}.card-reminders{grid-column:span 12;margin-top:18px}.reminders-list{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow-y:auto}.reminder-item{display:flex;align-items:center;gap:10px;padding:10px 13px;background:rgba(255,255,255,0.6);border-radius:12px;border-left:3px solid var(--rose-light);transition:all 0.2s}.reminder-item.done{opacity:0.45}.reminder-item.done .reminder-text{text-decoration:line-through}.reminder-item.is-daily{border-left-color:#7cbf9e}.reminder-item.is-persistent{border-left-color:#9bb4e8}.reminder-check{width:20px;height:20px;border-radius:50%;border:2px solid var(--rose-light);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.65rem;transition:all 0.2s}.reminder-check.checked{background:var(--rose);border-color:var(--rose);color:white}.reminder-content{flex:1;min-width:0}.reminder-text{font-size:0.88rem;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.reminder-meta{display:flex;gap:5px;align-items:center;margin-top:3px;flex-wrap:wrap}.r-time{font-size:0.73rem;color:var(--text-light)}.r-badge{font-size:0.65rem;padding:1px 7px;border-radius:20px;font-weight:700}.r-daily{background:#e6f4ee;color:#4a9a6a}.r-persistent{background:#e8edfc;color:#5c7ad4}.r-priority{width:8px;height:8px;border-radius:50%;flex-shrink:0}.p-high{background:#e07b8c}.p-med{background:var(--gold)}.p-low{background:#a8d5b5}.r-del{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:0.8rem;opacity:0;transition:opacity 0.2s;padding:2px 6px}.reminder-item:hover .r-del{opacity:1}.add-reminder-form{margin-top:14px;display:flex;flex-direction:column;gap:9px}.add-reminder-row{display:flex;gap:8px;flex-wrap:wrap}.reminder-options{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.toggle-opt{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:0.82rem;color:var(--text-mid);user-select:none}.toggle-opt input{accent-color:var(--rose);width:15px;height:15px;cursor:pointer}.input-base{border:1px solid rgba(201,116,138,0.25);border-radius:10px;padding:9px 13px;font-size:0.84rem;background:rgba(255,255,255,0.7);color:var(--text-dark);outline:none;transition:border-color 0.2s}.input-base:focus{border-color:var(--rose)}.btn-rose{background:var(--rose);color:white;border:none;border-radius:10px;padding:9px 16px;font-size:0.84rem;cursor:pointer;transition:background 0.2s,transform 0.15s;white-space:nowrap}.btn-rose:hover{background:#b85e76;transform:scale(1.03)}.persistent-banner{position:fixed;top:0;left:0;right:0;z-index:900;background:linear-gradient(90deg,#5c7ad4,#7a9ae8);color:white;padding:10px 20px;display:none;align-items:center;gap:10px;font-size:0.86rem;box-shadow:0 3px 20px rgba(92,122,212,0.35)}.persistent-banner.active{display:flex}.pb-items{flex:1;display:flex;flex-wrap:wrap;gap:6px}.pb-item{background:rgba(255,255,255,0.2);border-radius:20px;padding:3px 10px;font-size:0.8rem;display:flex;align-items:center;gap:6px}.pb-dismiss-one{background:none;border:none;color:rgba(255,255,255,0.75);cursor:pointer;font-size:0.78rem;padding:0}.pb-dismiss-all{background:rgba(255,255,255,0.25);border:1px solid rgba(255,255,255,0.4);border-radius:8px;color:white;cursor:pointer;padding:5px 12px;font-size:0.78rem;transition:background 0.2s}.pb-dismiss-all:hover{background:rgba(255,255,255,0.4)}.toast-stack{position:fixed;bottom:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:10px;align-items:flex-end;max-width:340px}.toast{background:white;border-left:4px solid var(--rose);border-radius:12px;padding:14px 18px;box-shadow:0 8px 40px rgba(170,100,120,0.22);width:100%;transform:translateX(110%);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1)}.toast.show{transform:translateX(0)}.toast-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:8px}.toast-title{font-family:'Playfair Display',serif;font-size:0.93rem;color:var(--text-dark)}.toast-close{background:none;border:1px solid rgba(201,116,138,0.3);border-radius:6px;padding:2px 9px;font-size:0.72rem;cursor:pointer;color:var(--text-light);flex-shrink:0}.toast-close:hover{background:var(--rose);color:white}.toast-body{font-size:0.82rem;color:var(--text-mid);line-height:1.4}.notif-banner{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:white;border:2px solid var(--rose);border-radius:16px;padding:16px 20px;box-shadow:0 8px 40px rgba(170,100,120,0.3);max-width:90%;width:360px;z-index:1100;display:none}.notif-banner.show{display:block}.notif-banner-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--text-dark);margin-bottom:6px;font-weight:700}.notif-banner-text{font-size:0.84rem;color:var(--text-mid);line-height:1.5;margin-bottom:12px}.notif-banner-btns{display:flex;gap:8px}.btn-ghost{background:none;border:1px solid rgba(201,116,138,0.3);border-radius:10px;padding:9px 18px;font-size:0.85rem;color:var(--text-mid);cursor:pointer;transition:all 0.2s}.btn-ghost:hover{border-color:var(--rose);color:var(--rose)}.upcoming-section{margin-top:14px;padding-top:12px;border-top:1px solid rgba(201,116,138,0.15)}.upcoming-title{font-size:0.7rem;letter-spacing:2px;text-transform:uppercase;color:var(--text-light);margin-bottom:8px;font-weight:700}.upcoming-item{font-size:0.82rem;color:var(--text-mid);padding:4px 0;line-height:1.4;display:flex;align-items:center;gap:6px}.upcoming-item .upcoming-emoji{flex-shrink:0}.upcoming-item.upcoming-today{font-size:1.05rem;font-weight:700;color:var(--rose);padding:6px 0;text-shadow:0 0 12px rgba(201,116,138,0.18)}.upcoming-item.upcoming-today .upcoming-label{background:var(--rose);color:white;padding:1px 8px;border-radius:10px;font-size:0.72rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-left:4px}.upcoming-none{font-size:0.78rem;color:var(--text-light);font-style:italic}.sound-toggle{position:fixed;bottom:24px;left:24px;z-index:800;background:var(--card-bg);border:1px solid rgba(201,116,138,0.25);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(170,100,120,0.15);transition:all 0.2s;font-size:1.2rem}.sound-toggle:hover{transform:scale(1.1);box-shadow:0 6px 28px rgba(170,100,120,0.25)}.sound-toggle.muted{opacity:0.5}.cal-event-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}.btn-cal-export{background:rgba(196,154,90,0.15);color:var(--gold);border:1px solid rgba(196,154,90,0.3);border-radius:8px;padding:4px 10px;font-size:0.72rem;cursor:pointer;transition:all 0.2s;font-weight:600;display:inline-flex;align-items:center;gap:4px}.btn-cal-export:hover{background:var(--gold);color:white}.event-detail-panel{margin-top:10px;padding:12px;background:rgba(255,255,255,0.6);border-radius:12px;border:1px solid rgba(201,116,138,0.12)}.event-detail-title{font-family:'Playfair Display',serif;font-size:0.95rem;color:var(--text-dark);margin-bottom:4px;display:flex;align-items:center;gap:6px}.event-detail-meta{font-size:0.78rem;color:var(--text-light);margin-bottom:4px}.event-detail-note{font-size:0.82rem;color:var(--text-mid);font-style:italic}@media(max-width:900px){.card-clock,.card-weather,.card-affirmation{grid-column:span 6}.card-calendar,.card-reminders{grid-column:span 12}}@media(max-width:600px){.card-clock,.card-weather,.card-affirmation{grid-column:span 12}}
</style>
</head>
<body>
<div class="persistent-banner" id="persistentBanner"><span>ğŸ“Œ</span><div class="pb-items" id="pbItems"></div><button class="pb-dismiss-all" onclick="dismissAll()">âœ“ Dismiss All</button></div>
<div class="container" id="mainContainer">
<header><div class="header-greeting">Good morning, my love âœ¦</div><div class="header-sub">Your beautiful day awaits</div><div class="header-divider"><span></span><span style="color:var(--rose)">â¤</span><span></span></div></header>
<div class="grid">
<div class="card card-clock"><div class="card-title">ğŸ• Time</div><div class="clock-time" id="clockTime">--:--</div><div class="clock-ampm" id="clockAmPm">--</div><div class="clock-date" id="clockDate">Loading...</div><div class="upcoming-section" id="upcomingSection"></div></div>
<div class="card card-weather"><div class="card-title">ğŸŒ¤ Weather</div><div class="weather-main"><div class="weather-emoji" id="wEmoji">ğŸŒ¸</div><div><div class="weather-temp" id="wTemp">--<span class="weather-unit">Â°</span></div><div class="weather-desc" id="wDesc">Tap button below</div><div class="weather-loc">ğŸ“ <span id="wCity">â€”</span></div></div></div><div class="weather-details"><div class="weather-detail"><div class="label">Feels like</div><div class="value" id="wFeels">â€”</div></div><div class="weather-detail"><div class="label">Humidity</div><div class="value" id="wHumidity">â€”</div></div><div class="weather-detail"><div class="label">Wind</div><div class="value" id="wWind">â€”</div></div></div><button class="location-btn" id="locationBtn" onclick="getWeather()">ğŸ“ Use My Location</button><div class="weather-status" id="wStatus"></div></div>
<div class="card card-affirmation"><div class="card-title">ğŸ’• Daily Love Note</div><div class="affirmation-text" id="affText">Loading...</div><div class="affirmation-footer"><span class="affirmation-num" id="affNum">1 / 30</span><button class="btn-affirmation" onclick="nextAff()">Next âœ¦</button></div></div>
<div class="card card-calendar"><div class="card-title">ğŸ“… Calendar</div><div class="calendar-nav"><button class="cal-btn" onclick="changeMonth(-1)">â€¹</button><div class="calendar-month" id="calLabel">â€”</div><button class="cal-btn" onclick="changeMonth(1)">â€º</button></div><div class="calendar-grid" id="calGrid"></div><div id="eventDetailPanel"></div></div>
<div class="card card-reminders"><div class="card-title">ğŸ”” Reminders</div><div class="reminders-list" id="remindersList"></div><div class="add-reminder-form"><div class="add-reminder-row"><input type="text" id="rInput" class="input-base" style="flex:1;min-width:130px" placeholder="Add a reminder..."/><input type="time" id="rTime" class="input-base" style="width:106px"/><select id="rPriority" class="input-base" style="width:112px"><option value="low">ğŸŸ¢ Low</option><option value="med" selected>ğŸŸ¡ Med</option><option value="high">ğŸ”´ High</option></select></div><div class="reminder-options"><label class="toggle-opt"><input type="checkbox" id="rDaily"/> ğŸ” Daily</label><label class="toggle-opt"><input type="checkbox" id="rPersistent"/> ğŸ“Œ Persistent</label><button class="btn-rose" onclick="addRem()">Add âœ¦</button></div></div></div>
</div>
</div>
<div class="notif-banner" id="notifBanner"><div class="notif-banner-title">ğŸ“± Enable Notifications?</div><div class="notif-banner-text">Get reminders and event alerts!</div><div class="notif-banner-btns"><button class="btn-ghost" style="flex:1;font-size:0.8rem;padding:7px" onclick="closeBanner()">Later</button><button class="btn-rose" style="flex:1;font-size:0.8rem;padding:7px" onclick="reqNotif()">Enable ğŸ’•</button></div></div>
<div class="toast-stack" id="toastStack"></div>
<button class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Toggle notification sound">ğŸ””</button>
<script>
let affIdx=0,weatherInt=null,calDate=new Date(),selDate=null,calEvents=[],pickedCat='birthday',reminders=[],activePersist=new Set(),notes=[],pickedColor='rose',soundEnabled=true;const AFFS=["You're the most beautiful girl in the whole world, and I mean it baby! â¤ï¸","Otti, you got this!! I believe in you 100%! ğŸ’ª","Hey you â€” yeah you â€” you're absolutely stunning today. No arguments! ğŸ˜¤ğŸ’•","Otti, you can do it! Whatever it is, you're gonna crush it! ğŸ”¥","I love you more than pizza. And you KNOW how much I love pizza. ğŸ•â¤ï¸","You're my favourite person on the entire planet. Not even a contest! ğŸ¥‡","Baby, you're literally glowing today. The sun is jealous, honestly. â˜€ï¸","Otti, you are the smartest, funniest, most wonderful girl â€” and you're MINE! ğŸ˜","You got it baby! Whatever today throws at you â€” you're ready! âœ¦","I just want you to know that you make every single day better just by existing. ğŸ’–","You're doing amazing, sweetheart. Like, genuinely ridiculously amazing. ğŸŒŸ","Otti! Wake up! It's time to go be absolutely incredible again! Let's gooo! ğŸ‰","Fact: you are the most beautiful girl I've ever seen. Science agrees. ğŸ”¬ğŸ’•","Hey love â€” you deserve all good things today. Every single one of them! ğŸŒ¸","You're stronger than you think, smarter than you know, and loved more than you imagine. ğŸ’•","Otti, I love you so much it's actually ridiculous. Just wanted to say that! ğŸ˜Š","You bring so much light into this world â€” especially into my world! âœ¨","Whatever mood you're in today â€” you still look gorgeous. That's just facts. ğŸ˜˜","Baby, you can conquer anything! Mountains, dragons, Mondays... all of it! âš”ï¸ğŸ’•","I choose you every single day, Otti. Yesterday, today, tomorrow â€” always. ğŸ’","Your smile is my favourite thing in the universe. Show it off today! ğŸ˜","You are 100% that girl. Never forget it! ğŸ‘‘","I'm the luckiest person alive because I get to love you. True story! ğŸ€â¤ï¸","Otti, go out there and be the queen you already are! The world isn't ready! ğŸ‘¸","Even when things are hard, you handle it with so much grace. I admire you so much! ğŸŒ¹","Good morning beautiful! Time to go be amazing â€” like you do every. single. day! â˜€ï¸","You deserve all the love, chocolate, and naps in the world. I'm working on it! ğŸ«ğŸ˜´ğŸ’•","Otti, honestly? You're my favourite. My absolute favourite. Don't tell anyone ğŸ¤«â¤ï¸","You make my heart do that stupid fluttery thing every time I think of you ğŸ¦‹ğŸ’•","I love you, I'm proud of you, and you're the best thing that ever happened to me! ğŸ¥¹â¤ï¸"],CAT_COLOR={birthday:'#e07b8c',appointment:'#5c7ad4',date:'#c9748a',anniversary:'#c49a5a',reminder:'#7cbf9e',other:'#9b8fc0'},CAT_EMO={birthday:'ğŸ‚',appointment:'ğŸ¥',date:'ğŸ’•',anniversary:'ğŸ’',reminder:'ğŸ””',other:'âœ¦'};

/* Audio context for notification sound */
let audioCtx=null;
function playNotifSound(){
if(!soundEnabled)return;
try{
if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();
osc.connect(gain);
gain.connect(audioCtx.destination);
osc.type='sine';
osc.frequency.setValueAtTime(880,audioCtx.currentTime);
osc.frequency.setValueAtTime(660,audioCtx.currentTime+0.1);
gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);
osc.start(audioCtx.currentTime);
osc.stop(audioCtx.currentTime+0.3);
}catch(e){}
}

function triggerVibration(){
try{if(navigator.vibrate)navigator.vibrate([200,100,200])}catch(e){}
}

function toggleSound(){
soundEnabled=!soundEnabled;
localStorage.setItem('soundEnabled',soundEnabled?'1':'0');
const btn=document.getElementById('soundToggle');
if(btn){
btn.textContent=soundEnabled?'ğŸ””':'ğŸ”•';
btn.classList.toggle('muted',!soundEnabled);
btn.title=soundEnabled?'Sound on â€” tap to mute':'Sound off â€” tap to unmute';
}
if(soundEnabled)playNotifSound();
}

function loadSoundPref(){
const stored=localStorage.getItem('soundEnabled');
soundEnabled=stored===null?true:stored==='1';
const btn=document.getElementById('soundToggle');
if(btn){
btn.textContent=soundEnabled?'ğŸ””':'ğŸ”•';
btn.classList.toggle('muted',!soundEnabled);
btn.title=soundEnabled?'Sound on â€” tap to mute':'Sound off â€” tap to unmute';
}
}

function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function fmt(t){if(!t)return'';const[h,m]=t.split(':').map(Number);return`${h%12||12}:${String(m).padStart(2,'0')} ${h>=12?'PM':'AM'}`}

function showToast(title,body){const stack=document.getElementById('toastStack');if(!stack)return;const t=document.createElement('div');t.className='toast';t.innerHTML=`<div class="toast-header"><div class="toast-title">${title}</div><button class="toast-close" onclick="this.closest('.toast').remove()">âœ•</button></div><div class="toast-body">${body}</div>`;stack.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),400)},5000)}

function sendNotif(title,body,persist=false){
triggerVibration();
playNotifSound();
if(!('Notification' in window)){showToast(title,body);return}
if(Notification.permission==='granted'){
try{
const n=new Notification(title,{body:body,vibrate:[200,100,200],requireInteraction:persist,tag:title+Date.now()});
n.onclick=function(){window.focus();this.close()}
}catch(e){showToast(title,body)}
}else{showToast(title,body)}
}

function reqNotif(){if(!('Notification' in window)){alert('Notifications not supported');closeBanner();return}Notification.requestPermission().then(perm=>{if(perm==='granted'){sendNotif('âœ¨ All set!','You\'ll get reminders now! ğŸ’•');localStorage.setItem('notifReq','1');closeBanner()}else{showToast('âš ï¸ Blocked','Enable in settings');closeBanner()}})}
function closeBanner(){const b=document.getElementById('notifBanner');if(b)b.classList.remove('show');localStorage.setItem('notifReq','1')}
function showBannerIfNeeded(){if(!('Notification' in window))return;if(localStorage.getItem('notifReq'))return;if(Notification.permission==='granted')return;setTimeout(()=>{const b=document.getElementById('notifBanner');if(b)b.classList.add('show')},3000)}

function loadAff(){const today=new Date().toDateString();if(localStorage.getItem('affDay')!==today){affIdx=new Date().getDate()%AFFS.length;localStorage.setItem('affIdx',affIdx);localStorage.setItem('affDay',today)}else{affIdx=parseInt(localStorage.getItem('affIdx')||'0')}showAff()}
function showAff(){const el=document.getElementById('affText');if(el)el.textContent=AFFS[affIdx];const numEl=document.getElementById('affNum');if(numEl)numEl.textContent=`${affIdx+1} / ${AFFS.length}`}
function nextAff(){affIdx=(affIdx+1)%AFFS.length;localStorage.setItem('affIdx',affIdx);const el=document.getElementById('affText');if(el){el.style.opacity='0';setTimeout(()=>{showAff();el.style.opacity='1'},250)}}

function updateClock(){const now=new Date();let h=now.getHours();const m=String(now.getMinutes()).padStart(2,'0');const ampm=h>=12?'PM':'AM';h=h%12||12;const timeEl=document.getElementById('clockTime');if(timeEl)timeEl.textContent=`${String(h).padStart(2,'0')}:${m}`;const ampmEl=document.getElementById('clockAmPm');if(ampmEl)ampmEl.textContent=ampm;const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];const months=['January','February','March','April','May','June','July','August','September','October','November','December'];const dateEl=document.getElementById('clockDate');if(dateEl)dateEl.textContent=`${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;checkRem(now);renderUpcoming()}

/* Upcoming events in the Time card */
function renderUpcoming(){
const section=document.getElementById('upcomingSection');
if(!section)return;
const now=new Date();
const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
const todayStr=today.toISOString().split('T')[0];
const upcoming=[];
for(let i=0;i<=7;i++){
const d=new Date(today);d.setDate(d.getDate()+i);
const ds=d.toISOString().split('T')[0];
calEvents.filter(e=>e.date===ds).forEach(e=>{
upcoming.push({...e,daysAway:i,dateObj:d});
});
}
if(!upcoming.length){
section.innerHTML='<div class="upcoming-title">Upcoming</div><div class="upcoming-none">No events in the next 7 days</div>';
return;
}
let html='<div class="upcoming-title">Upcoming</div>';
upcoming.forEach(e=>{
const emoji=CAT_EMO[e.cat]||'ğŸ“…';
const isToday=e.daysAway===0;
const cls=isToday?'upcoming-item upcoming-today':'upcoming-item';
let label='';
if(isToday){
label=`<span class="upcoming-emoji">${emoji}</span><strong>${esc(e.title)}</strong><span class="upcoming-label">Today!</span>`;
}else if(e.daysAway===1){
label=`<span class="upcoming-emoji">${emoji}</span>Upcoming: ${esc(e.title)} in 1 day`;
}else{
label=`<span class="upcoming-emoji">${emoji}</span>Upcoming: ${esc(e.title)} in ${e.daysAway} days`;
}
html+=`<div class="${cls}">${label}</div>`;
});
section.innerHTML=html;
}

/* Generate .ics file content for calendar export */
function generateICS(event){
const pad=s=>String(s).padStart(2,'0');
const d=new Date(event.date+'T'+(event.time||'00:00'));
const yr=d.getFullYear();
const mo=pad(d.getMonth()+1);
const dy=pad(d.getDate());
const hr=pad(d.getHours());
const mn=pad(d.getMinutes());
const dtStart=event.time?`${yr}${mo}${dy}T${hr}${mn}00`:`${yr}${mo}${dy}`;
const endD=new Date(d);
if(event.time){endD.setHours(endD.getHours()+1)}else{endD.setDate(endD.getDate()+1)}
const eyr=endD.getFullYear();
const emo=pad(endD.getMonth()+1);
const edy=pad(endD.getDate());
const ehr=pad(endD.getHours());
const emn=pad(endD.getMinutes());
const dtEnd=event.time?`${eyr}${emo}${edy}T${ehr}${emn}00`:`${eyr}${emo}${edy}`;
const uid=`${event.id}@ottidashboard`;
const now=new Date();
const stamp=`${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}T${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
return[
'BEGIN:VCALENDAR',
'VERSION:2.0',
'PRODID:-//OttiDashboard//EN',
'BEGIN:VEVENT',
`UID:${uid}`,
`DTSTAMP:${stamp}`,
`DTSTART:${dtStart}`,
`DTEND:${dtEnd}`,
`SUMMARY:${event.title}`,
event.note?`DESCRIPTION:${event.note}`:'',
'END:VEVENT',
'END:VCALENDAR'
].filter(Boolean).join('\r\n');
}

function addToCalendar(eventId){
const ev=calEvents.find(e=>e.id===eventId);
if(!ev)return;
const ics=generateICS(ev);
const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`${ev.title.replace(/[^a-zA-Z0-9]/g,'_')}.ics`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
showToast('ğŸ“… Exported',`"${ev.title}" ready to add to calendar`);
}

async function getWeather(){const btn=document.getElementById('locationBtn');const status=document.getElementById('wStatus');if(btn)btn.disabled=true;if(btn)btn.textContent='ğŸ“ Getting...';if(status)status.textContent='Getting location...';if(!navigator.geolocation){if(status)status.textContent='âš ï¸ Not supported';if(btn){btn.disabled=false;btn.textContent='ğŸ“ Try Again'}return}navigator.geolocation.getCurrentPosition(async(pos)=>{const lat=pos.coords.latitude;const lon=pos.coords.longitude;localStorage.setItem('savedLat',lat);localStorage.setItem('savedLon',lon);await fetchW(lat,lon);if(btn)btn.textContent='âœ“ Active';if(weatherInt)clearInterval(weatherInt);weatherInt=setInterval(()=>{const sLat=localStorage.getItem('savedLat');const sLon=localStorage.getItem('savedLon');if(sLat&&sLon)fetchW(parseFloat(sLat),parseFloat(sLon))},3600000);if(btn)btn.disabled=false},(err)=>{let msg='âš ï¸ ';if(err.code===1)msg+='Permission denied';else if(err.code===2)msg+='Unavailable';else if(err.code===3)msg+='Timeout';if(status)status.textContent=msg;if(btn){btn.disabled=false;btn.textContent='ğŸ“ Try Again'}})}
async function fetchW(lat,lon){const status=document.getElementById('wStatus');if(status)status.textContent='Fetching... ğŸŒ¸';try{const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weathercode,windspeed_10m&timezone=auto`;const res=await fetch(url,{signal:AbortSignal.timeout(10000)});if(!res.ok)throw new Error('Failed');const data=await res.json();const cur=data.current;const geoUrl=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`;let cityName='Your Location';try{const geoRes=await fetch(geoUrl,{signal:AbortSignal.timeout(5000),headers:{'User-Agent':'OttiApp/1.0'}});if(geoRes.ok){const geoData=await geoRes.json();cityName=geoData.address.city||geoData.address.town||geoData.address.village||'Your Location'}}catch(e){}const tempC=Math.round(cur.temperature_2m);const feelsC=Math.round(cur.apparent_temperature);const humidity=cur.relative_humidity_2m;const windKmh=Math.round(cur.windspeed_10m);const code=cur.weathercode;const weatherMap={0:{emoji:'â˜€ï¸',desc:'Clear Sky'},1:{emoji:'ğŸŒ¤',desc:'Mainly Clear'},2:{emoji:'â›…',desc:'Partly Cloudy'},3:{emoji:'â˜ï¸',desc:'Overcast'},45:{emoji:'ğŸŒ«',desc:'Foggy'},51:{emoji:'ğŸŒ¦',desc:'Drizzle'},61:{emoji:'ğŸŒ§',desc:'Rain'},71:{emoji:'ğŸŒ¨',desc:'Snow'},80:{emoji:'ğŸŒ¦',desc:'Showers'},95:{emoji:'â›ˆ',desc:'Thunderstorm'}};const weather=weatherMap[code]||{emoji:'ğŸŒ¤',desc:'Nice Day'};const emojiEl=document.getElementById('wEmoji');if(emojiEl)emojiEl.textContent=weather.emoji;const tempEl=document.getElementById('wTemp');if(tempEl)tempEl.innerHTML=`${tempC}<span class="weather-unit">Â°C</span>`;const descEl=document.getElementById('wDesc');if(descEl)descEl.textContent=weather.desc;const cityEl=document.getElementById('wCity');if(cityEl)cityEl.textContent=cityName;const feelsEl=document.getElementById('wFeels');if(feelsEl)feelsEl.textContent=`${feelsC}Â°C`;const humidEl=document.getElementById('wHumidity');if(humidEl)humidEl.textContent=`${humidity}%`;const windEl=document.getElementById('wWind');if(windEl)windEl.textContent=`${windKmh} km/h`;const now=new Date();if(status)status.textContent=`Updated: ${now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`}catch(e){if(status)status.textContent='âš ï¸ Error loading weather'}}

function loadCal(){calEvents=JSON.parse(localStorage.getItem('calEventsV3')||'[]')}
function saveCal(){localStorage.setItem('calEventsV3',JSON.stringify(calEvents))}

function renderCal(){const mNames=['January','February','March','April','May','June','July','August','September','October','November','December'];const labelEl=document.getElementById('calLabel');if(labelEl)labelEl.textContent=`${mNames[calDate.getMonth()]} ${calDate.getFullYear()}`;const grid=document.getElementById('calGrid');if(!grid)return;grid.innerHTML='';['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d=>{const el=document.createElement('div');el.className='cal-day-name';el.textContent=d;grid.appendChild(el)});const first=new Date(calDate.getFullYear(),calDate.getMonth(),1);const last=new Date(calDate.getFullYear(),calDate.getMonth()+1,0);const today=new Date();for(let i=0;i<first.getDay();i++){const d=new Date(calDate.getFullYear(),calDate.getMonth(),-first.getDay()+i+1);const el=document.createElement('div');el.className='cal-day other-month';el.textContent=d.getDate();grid.appendChild(el)}for(let d=1;d<=last.getDate();d++){const el=document.createElement('div');el.className='cal-day';el.textContent=d;const ds=`${calDate.getFullYear()}-${String(calDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;if(d===today.getDate()&&calDate.getMonth()===today.getMonth()&&calDate.getFullYear()===today.getFullYear())el.classList.add('today');if(calEvents.some(e=>e.date===ds))el.classList.add('has-event');el.onclick=()=>{selDate=ds;renderCal();renderSelectedDayEvents(ds)};grid.appendChild(el)}}

function renderSelectedDayEvents(ds){
const panel=document.getElementById('eventDetailPanel');
if(!panel)return;
const dayEvents=calEvents.filter(e=>e.date===ds);
if(!dayEvents.length){panel.innerHTML='';return}
let html='';
dayEvents.forEach(e=>{
const emoji=CAT_EMO[e.cat]||'ğŸ“…';
const color=CAT_COLOR[e.cat]||'var(--text-mid)';
html+=`<div class="event-detail-panel">
<div class="event-detail-title" style="color:${color}">${emoji} ${esc(e.title)}</div>
${e.time?`<div class="event-detail-meta">â° ${fmt(e.time)}</div>`:''}
${e.note?`<div class="event-detail-note">${esc(e.note)}</div>`:''}
<div class="cal-event-actions">
<button class="btn-cal-export" onclick="addToCalendar(${e.id})">ğŸ“¥ Add to Calendar</button>
</div>
</div>`;
});
panel.innerHTML=html;
}

function changeMonth(dir){calDate=new Date(calDate.getFullYear(),calDate.getMonth()+dir,1);renderCal()}

function checkEvents(){const now=new Date();const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());const todayStr=today.toISOString().split('T')[0];const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);const tomorrowStr=tomorrow.toISOString().split('T')[0];calEvents.filter(e=>e.date===todayStr).forEach(e=>{const k=`evn_${e.id}_${todayStr}`;if(!localStorage.getItem(k)){sendNotif(`${CAT_EMO[e.cat]||'ğŸ“…'} Today: ${e.title}`,e.note||'Don\'t forget!');showToast(`${CAT_EMO[e.cat]||'ğŸ“…'} Today`,e.title);localStorage.setItem(k,'1')}});calEvents.filter(e=>e.date===tomorrowStr).forEach(e=>{const k=`evn_tmr_${e.id}_${todayStr}`;if(!localStorage.getItem(k)){sendNotif(`${CAT_EMO[e.cat]||'ğŸ“…'} Tomorrow: ${e.title}`,e.note||'Tomorrow!');localStorage.setItem(k,'1')}});const currentTime=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;calEvents.filter(e=>e.date===todayStr&&e.time).forEach(e=>{const k=`evn_time_${e.id}_${todayStr}`;if(e.time===currentTime&&!localStorage.getItem(k)){sendNotif(`${CAT_EMO[e.cat]||'ğŸ“…'} ${e.title} - NOW!`,'Starting now!',true);localStorage.setItem(k,'1')}})}

function loadRem(){reminders=JSON.parse(localStorage.getItem('remindersV3')||'[]')}
function saveRem(){localStorage.setItem('remindersV3',JSON.stringify(reminders))}

function renderRem(){const list=document.getElementById('remindersList');if(!list)return;list.innerHTML='';if(!reminders.length){list.innerHTML='<div style="text-align:center;color:var(--text-light);font-size:0.85rem;padding:20px;font-style:italic">No reminders yet ğŸŒ¸</div>';return}[...reminders].sort((a,b)=>(a.time||'99:99').localeCompare(b.time||'99:99')).forEach(r=>{const el=document.createElement('div');el.className='reminder-item'+(r.done?' done':'')+(r.daily?' is-daily':'')+(r.persistent?' is-persistent':'');el.innerHTML=`<div class="reminder-check${r.done?' checked':''}" onclick="toggleRem(${r.id})">${r.done?'âœ“':''}</div><div class="reminder-content"><div class="reminder-text">${esc(r.text)}</div><div class="reminder-meta">${r.time?`<span class="r-time">â° ${fmt(r.time)}</span>`:''}${r.daily?'<span class="r-badge r-daily">ğŸ”</span>':''}${r.persistent?'<span class="r-badge r-persistent">ğŸ“Œ</span>':''}</div></div><div class="r-priority p-${r.priority}"></div><button class="r-del" onclick="delRem(${r.id})">âœ•</button>`;list.appendChild(el)})}

function addRem(){const textEl=document.getElementById('rInput');const timeEl=document.getElementById('rTime');const priorityEl=document.getElementById('rPriority');const dailyEl=document.getElementById('rDaily');const persistEl=document.getElementById('rPersistent');const text=textEl?textEl.value.trim():'';if(!text)return;const time=timeEl?timeEl.value:'';const priority=priorityEl?priorityEl.value:'med';const daily=dailyEl?dailyEl.checked:false;const persistent=persistEl?persistEl.checked:false;reminders.push({id:Date.now(),text,time,priority,daily,persistent,done:false,notified:false,lastDay:''});saveRem();renderRem();if(textEl)textEl.value='';if(timeEl)timeEl.value='';if(dailyEl)dailyEl.checked=false;if(persistEl)persistEl.checked=false;showToast('âœ¦ Added',text)}
function toggleRem(id){const r=reminders.find(x=>x.id===id);if(!r)return;r.done=!r.done;if(r.daily&&r.done)r.notified=false;saveRem();renderRem();updatePersist()}
function delRem(id){reminders=reminders.filter(x=>x.id!==id);saveRem();renderRem();updatePersist()}

function checkRem(now){const cur=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;const today=now.toDateString();let changed=false;reminders.forEach(r=>{if(!r.time||r.done)return;if(r.daily&&r.lastDay!==today)r.notified=false;if(!r.notified&&r.time===cur){r.notified=true;if(r.daily)r.lastDay=today;changed=true;sendNotif('ğŸ”” Reminder!',r.text,r.persistent);if(r.persistent){const pk=`pkey_${r.id}_${today}`;if(!localStorage.getItem(pk)){localStorage.setItem(pk,'1');activePersist.add(`${r.id}||${today}`);updatePersist()}}else{showToast('ğŸ”” Reminder!',r.text)}}});if(changed)saveRem()}

function loadPersist(){const today=new Date().toDateString();reminders.filter(r=>r.persistent).forEach(r=>{const pk=`pkey_${r.id}_${today}`;const dk=`pdismiss_${r.id}_${today}`;if(localStorage.getItem(pk)&&!localStorage.getItem(dk))activePersist.add(`${r.id}||${today}`)});updatePersist()}
function updatePersist(){const today=new Date().toDateString();const banner=document.getElementById('persistentBanner');const items=document.getElementById('pbItems');const mainC=document.getElementById('mainContainer');if(!banner||!items)return;items.innerHTML='';const active=[];activePersist.forEach(key=>{const id=parseInt(key.split('||')[0]);const r=reminders.find(x=>x.id===id);if(r&&!r.done)active.push({key,r})});if(!active.length){banner.classList.remove('active');if(mainC)mainC.style.paddingTop='28px';return}banner.classList.add('active');if(mainC)mainC.style.paddingTop='76px';active.forEach(({key,r})=>{const el=document.createElement('div');el.className='pb-item';el.innerHTML=`ğŸ“Œ ${esc(r.text)}${r.time?' Â· '+fmt(r.time):''}<button class="pb-dismiss-one" onclick="dismissOne('${key}')">âœ•</button>`;items.appendChild(el)})}
function dismissOne(key){const id=parseInt(key.split('||')[0]);const today=new Date().toDateString();localStorage.setItem(`pdismiss_${id}_${today}`,'1');activePersist.delete(key);updatePersist()}
function dismissAll(){const today=new Date().toDateString();activePersist.forEach(key=>{const id=parseInt(key.split('||')[0]);localStorage.setItem(`pdismiss_${id}_${today}`,'1')});activePersist.clear();updatePersist()}

function init(){
loadSoundPref();
loadAff();updateClock();setInterval(updateClock,1000);
loadCal();renderCal();renderUpcoming();
loadRem();renderRem();loadPersist();
showBannerIfNeeded();
const sLat=localStorage.getItem('savedLat');const sLon=localStorage.getItem('savedLon');
if(sLat&&sLon){fetchW(parseFloat(sLat),parseFloat(sLon));weatherInt=setInterval(()=>fetchW(parseFloat(sLat),parseFloat(sLon)),3600000)}
const today=new Date().toDateString();
if(localStorage.getItem('lastAffNotif')!==today){setTimeout(()=>{showToast('ğŸ’• Good morning, Otti!',AFFS[affIdx].substring(0,80)+'...');localStorage.setItem('lastAffNotif',today)},1500)}
setTimeout(checkEvents,2500);setInterval(checkEvents,60000);
if(document.getElementById('rInput'))document.getElementById('rInput').addEventListener('keydown',e=>{if(e.key==='Enter')addRem()});
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
